<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Card</title>
    <!-- ì–´ìš¸ë¦¬ëŠ” íŒŒë¹„ì½˜ (ì¹´ë“œ ì¸ë±ìŠ¤ ì´ëª¨ì§€) --><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—‚ï¸</text></svg>">
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ (íŠ¸ë Œë””í•œ ëŠë‚Œ) --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Nanum Gothic', 'Inter', sans-serif;
            overflow: hidden;
            position: relative; /* ì €ì‘ê¶Œ ë¬¸êµ¬ë¥¼ ìœ„í•´ í•„ìš” */
            color: #333; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ (í° ë°°ê²½ìš©) */
            transition: color 0.8s ease;
        }

        /* ê±°ê¾¸ë¡œ ëª¨ë“œ ì‹œ body í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
        body.reverse-active {
            color: white; /* ê²€ì€ ë°°ê²½ìš© */
        }

        /* í™”ë©´ ì „í™˜ì„ ìœ„í•œ ê¸°ë³¸ í´ë˜ìŠ¤ */
        .screen {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  í™”ë©´ ìˆ¨ê¹€ */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 10; /* í™”ë©´ì´ ë°°ê²½ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
        }
        
        /* í™œì„± í™”ë©´ */
        .screen.active {
            display: flex; /* flex-direction: columnì€ HTMLì— ì§ì ‘ ì ìš© */
            opacity: 1;
        }

        /* ìƒˆë¡œìš´ ë°°ê²½ ìŠ¤íƒ€ì¼ */
        #animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* -1ë¡œ ë³€ê²½í•˜ì—¬ ë¬´ì¡°ê±´ ë’¤ë¡œ ë³´ëƒ„ */
            overflow: hidden;
            background-color: white; /* ê¸°ë³¸ í°ìƒ‰ ë°°ê²½ */
            transition: background-color 0.8s ease; /* ê±°ê¾¸ë¡œ ëª¨ë“œ ì „í™˜ */
        }

        #animated-bg.reverse-active {
            background-color: black; /* ê±°ê¾¸ë¡œ ëª¨ë“œ ì‹œ ê²€ì •ìƒ‰ ë°°ê²½ */
        }

        .bg-word {
            position: absolute;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0.08; /* ë¹¼ê³¡íˆ ì±„ìš°ê¸° ìœ„í•´ íˆ¬ëª…ë„ ë‚®ì¶¤ */
            pointer-events: none; /* í´ë¦­ ì•ˆ ë˜ê²Œ */
            animation: moveWords linear infinite;
        }

        /* ê¸°ë³¸ ëª¨ë“œ ë‹¨ì–´ ìƒ‰ìƒ (í°ìƒ‰ ë°°ê²½ì— ì–´ìš¸ë¦¬ê²Œ) */
        .bg-word {
            color: #333;
        }

        /* ê±°ê¾¸ë¡œ ëª¨ë“œ ë‹¨ì–´ ìƒ‰ìƒ (ê²€ì • ë°°ê²½ì— ì–´ìš¸ë¦¬ê²Œ) */
        #animated-bg.reverse-active .bg-word {
            color: white;
            opacity: 0.15; /* 0.08ë³´ë‹¤ ì˜ ë³´ì´ê²Œ */
        }

        @keyframes moveWords {
            /* 0%: í™”ë©´ ë°– ì˜¤ë¥¸ìª½ ì•„ë˜ -> 100%: í™”ë©´ ë°– ì™¼ìª½ ìœ„ */
            0% { transform: translate(100vw, 100vh) rotate(20deg); }
            100% { transform: translate(-50vw, -100vh) rotate(20deg); }
        }

        /* ë¬¸ì œ í’€ì´ í™”ë©´ì€ ë°°ê²½ ì—†ìŒ + í•­ìƒ í°ìƒ‰ í…ìŠ¤íŠ¸ */
        #quiz-screen.active ~ #animated-bg {
            display: none;
        }
        #quiz-screen {
            background-color: #111827; /* ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
            color: white;
        }

        /* ëª¨ë‹¬ (í•­ìƒ í°ìƒ‰ í…ìŠ¤íŠ¸) */
        #pause-modal, #retake-modal, #alert-modal {
            color: white;
        }

        /* ê´€ë¦¬ì ë¡œê·¸ì¸ (í•­ìƒ í°ìƒ‰ í…ìŠ¤íŠ¸) */
        #admin-login-screen .login-panel {
            color: white;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (WebKit) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* ì„ íƒëœ ë¬¸ì œ ì„¸íŠ¸ ìŠ¤íƒ€ì¼ */
        .set-item.selected {
            background-color: #FBBF24; /* í™©ìƒ‰ */
            color: #1f2937; /* ì„ íƒ ì‹œ í…ìŠ¤íŠ¸ ê²€ì • */
            border-color: #FBBF24;
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* ì €ì‘ê¶Œ ë¬¸êµ¬ */
        #copyright-footer {
            position: fixed;
            bottom: 10px;
            right: 15px;
            color: #a0a0a0; /* íšŒìƒ‰ */
            font-size: 0.85em;
            z-index: 100; /* ëª¨ë“  í™”ë©´ ìœ„ì— ì˜¤ë„ë¡ */
        }

        /* ê±°ê¾¸ë¡œ ëª¨ë“œ: 'ë¬¸ì œ í’€ì´ ì‹œì‘' ë²„íŠ¼ ìƒ‰ìƒ ë°˜ì „ */
        body.reverse-active #start-quiz-btn:not(:disabled) {
            background-color: #ffffff; /* í°ìƒ‰ ë°°ê²½ */
            color: #16a34a; /* ì´ˆë¡ìƒ‰ í…ìŠ¤íŠ¸ (green-600) */
        }
        body.reverse-active #start-quiz-btn:not(:disabled):hover {
            background-color: #e5e5e5; /* ë°ì€ íšŒìƒ‰ (hover) */
        }
        
        /* ê±°ê¾¸ë¡œ ëª¨ë“œ: 'ë¬¸ì œ í’€ì´ ì‹œì‘' ë¹„í™œì„± ë²„íŠ¼ ìƒ‰ìƒ ë°˜ì „ */
        body.reverse-active #start-quiz-btn:disabled {
            background-color: #374151; /* ì–´ë‘ìš´ íšŒìƒ‰ (gray-700) */
            color: #9ca3af; /* ë°ì€ íšŒìƒ‰ í…ìŠ¤íŠ¸ (gray-400) */
            opacity: 0.6;
        }

        /* ê±°ê¾¸ë¡œ ëª¨ë“œ: ê²€ìƒ‰ì°½/ë¦¬ìŠ¤íŠ¸ì°½ ë°ê²Œ */
        body.reverse-active #search-bar {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        body.reverse-active #problem-list-container {
            background-color: rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class=""> <!-- color: white ì œê±°, body.reverse-activeë¡œ ì œì–´ -->

    <!-- ì• ë‹ˆë©”ì´ì…˜ ë°°ê²½ (JSë¡œ ë‹¨ì–´ ìƒì„±) --><div id="animated-bg">
        <!-- JSë¡œ .bg-word ìš”ì†Œë“¤ ìƒì„± -->
    </div>

    <!-- ì €ì‘ê¶Œ ë¬¸êµ¬ --><div id="copyright-footer">
        â“’ 2025 Yun Hyun Su all rights reserved.
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ --><div id="loading-overlay" class="screen fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- 1. ë©”ì¸ í™”ë©´ (ë ˆì´ì•„ì›ƒ ì¬êµ¬ì„±) -->
    <div id="main-screen" class="screen active flex flex-col p-6 md:p-10 relative"> <!-- position: relative ì¶”ê°€ -->
        
        <!-- í—¤ë” (ê³ ì •) -->
        <header class="flex justify-between items-center mb-6 flex-shrink-0">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold">Flash Card</h1>
            <button id="main-admin-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                ê´€ë¦¬ì íŒ¨ë„
            </button>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
        <main class="flex-1 flex flex-col min-h-0"> <!-- min-h-0ê°€ flex-child ìŠ¤í¬ë¡¤ì— ì¤‘ìš” -->
            
            <!-- ì˜µì…˜ (ê³ ì •) -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 flex-shrink-0">
                <!-- ê±°ê¾¸ë¡œ ëª¨ë“œ í† ê¸€ -->
                <div class="flex items-center space-x-3 bg-gray-800 bg-opacity-70 p-3 rounded-lg text-white">
                    <span class="text-lg font-medium">ê±°ê¾¸ë¡œ ë¬¸ì œ ëª¨ë“œ</span>
                    <label class="switch">
                        <input type="checkbox" id="reverse-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- ê²€ìƒ‰ ë°” -->
                <input id="search-bar" type="text" placeholder="ë¬¸ì œ ì„¸íŠ¸ ê²€ìƒ‰..." class="w-full md:w-1/2 p-3 rounded-lg bg-gray-800 bg-opacity-70 border border-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-300">
            </div>

            <!-- ë¦¬ìŠ¤íŠ¸ í—¤ë” (ê³ ì •) -->
            <h2 id="problem-list-header" class="text-2xl font-semibold mb-4 flex-shrink-0">ë¬¸ì œ ë¦¬ìŠ¤íŠ¸</h2>

            <!-- ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ (ìŠ¤í¬ë¡¤) -->
            <div id="problem-list-container" class="flex-1 overflow-y-auto space-y-3 p-2 bg-black bg-opacity-10 rounded-lg transition-colors duration-300">
                <p id="no-public-sets" class="text-center">ê³µê°œëœ ë¬¸ì œ ì„¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>

            <!-- ë¬¸ì œ í’€ì´ ì‹œì‘ ë²„íŠ¼ (ê³ ì •) -->
            <div class="mt-6 flex-shrink-0">
                <button id="start-quiz-btn" class="w-full bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ë¬¸ì œ ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”
                </button>
            </div>
        </main>
    </div>

    <!-- 2. ê´€ë¦¬ì ë¡œê·¸ì¸ --><div id="admin-login-screen" class="screen flex-col p-6 md:p-10 justify-center items-center bg-gray-900 bg-opacity-80">
        <div class="login-panel w-full max-w-md bg-gray-800 p-8 rounded-2xl shadow-xl text-white"> <!-- text-white ê³ ì • -->
            <h2 class="text-3xl font-bold text-center mb-6">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <p id="login-error" class="text-red-400 text-center mb-4 hidden">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
            <input type="password" id="admin-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-6">
            <button id="admin-login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                ì ‘ì†
            </button>
            <button id="admin-login-back-btn" class="w-full text-center text-gray-400 hover:text-white mt-6">
                ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <!-- 3. ê´€ë¦¬ì íŒ¨ë„ (ë¬¸ì œ ë¦¬ìŠ¤íŠ¸) --><div id="admin-panel-screen" class="screen flex-col p-6 md:p-10">
        <header class="flex justify-between items-center mb-6 flex-shrink-0">
            <button id="admin-panel-back-btn" class="text-3xl hover:text-indigo-400 transition-colors">â†</button>
            <h1 class="text-3xl font-bold">ê´€ë¦¬ì íŒ¨ë„</h1>
            <button id="admin-add-set-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                + ë¬¸ì œ ì¶”ê°€í•˜ê¸°
            </button>
        </header>
        
        <main class="flex-1 flex flex-col min-h-0">
            <h2 class="text-2xl font-semibold mb-4 flex-shrink-0">ì „ì²´ ë¬¸ì œ ì„¸íŠ¸</h2>
            <div id="admin-problem-list" class="flex-1 overflow-y-auto space-y-3 p-2 bg-black bg-opacity-10 rounded-lg">
                <!-- JSë¡œ ê´€ë¦¬ììš© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
            </div>
        </main>
    </div>

    <!-- 4. ê´€ë¦¬ì - ë¬¸ì œ ì¶”ê°€/ìˆ˜ì • --><div id="admin-edit-screen" class="screen flex-col p-6 md:p-10">
        <header class="flex justify-between items-center mb-6 flex-shrink-0">
            <button id="admin-edit-back-btn" class="text-3xl hover:text-indigo-400 transition-colors">â†</button>
            <h1 id="edit-screen-title" class="text-3xl font-bold">ë¬¸ì œ ì„¸íŠ¸ ë§Œë“¤ê¸°</h1>
            <button id="save-set-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                ì €ì¥í•˜ê¸°
            </button>
        </header>

        <main class="flex-1 overflow-y-auto">
            <!-- ë¬¸ì œ ì„¸íŠ¸ ì •ë³´ --><div class="mb-6 space-y-4 max-w-2xl mx-auto">
                <input type="hidden" id="edit-set-id">
                <div>
                    <label for="set-title-input" class="block text-lg font-medium mb-2">ë¬¸ì œ ì œëª© (í•„ìˆ˜)</label>
                    <input type="text" id="set-title-input" placeholder="ì˜ˆ: 2025ë…„ 1íšŒ ì˜ë‹¨ì–´" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="set-description-input" class="block text-lg font-medium mb-2">ë¬¸ì œ ì„¤ëª… (ì„ íƒ)</label>
                    <textarea id="set-description-input" rows="3" placeholder="ì˜ˆ: 1ê³¼ë¶€í„° 3ê³¼ê¹Œì§€ì˜ ì¤‘ìš” ë‹¨ì–´" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
            </div>

            <!-- ë¬¸ì œ/ì •ë‹µ ëª©ë¡ --><div class="max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">ë¬¸ì œ/ì •ë‹µ ëª©ë¡</h2>
                    <button id="add-qa-pair-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">
                        + ë¬¸ì œ ì¶”ê°€í•˜ê¸°
                    </button>
                </div>
                <div id="qa-list-container" class="space-y-4">
                    <!-- JSë¡œ Q&A ìŒ ë Œë”ë§ --></div>
            </div>
        </main>
    </div>

    <!-- 5. ë¬¸ì œ í’€ì´ í™”ë©´ --><div id="quiz-screen" class="screen flex-col p-6 md:p-10 justify-between text-white"> <!-- text-white ê³ ì • -->
        <!-- ìƒë‹¨: ì¤‘ë‹¨ ë²„íŠ¼ ë° ì§„í–‰ë„ --><header class="flex justify-between items-center flex-shrink-0">
            <button id="pause-btn" class="text-2xl w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full hover:bg-gray-600">
                ||
            </button>
            <div id="quiz-progress" class="text-lg font-medium">1 / 10</div>
        </header>
        
        <!-- ë¬¸ì œ --><div class="flex-1 flex flex-col justify-center items-center text-center px-4">
            <div id="question-text" class="text-4xl md:text-6xl font-bold mb-12 p-6 bg-gray-800 rounded-2xl min-h-[150px] flex items-center justify-center w-full max-w-3xl">
                Question
            </div>

            <!-- ë‹µì•ˆ ì…ë ¥ --><input type="text" id="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full max-w-xl p-4 text-2xl rounded-lg bg-gray-700 border border-gray-600 text-white text-center focus:outline-none focus:ring-2 focus:ring-indigo-500">

            <!-- í”¼ë“œë°± --><div id="feedback-message" class="mt-6 text-2xl font-semibold h-10"></div>
            
            <!-- ë‹¤ìŒ ë²„íŠ¼ (í‹€ë ¸ì„ ë•Œ) --><button id="next-question-btn" class="hidden mt-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg">
                ë‹¤ìŒ â†’
            </button>
        </div>

        <!-- í•˜ë‹¨ (ë¹ˆ ê³µê°„) --><div class="flex-shrink-0"></div>
    </div>

    <!-- 6. ì¤‘ë‹¨ ëª¨ë‹¬ --><div id="pause-modal" class="screen flex-col justify-center items-center z-40 text-white"> <!-- text-white ê³ ì • -->
        <div class="fixed inset-0 bg-black bg-opacity-80"></div>
        <div class="relative z-10">
            <h2 class="text-4xl font-bold mb-8">ì¤‘ë‹¨</h2>
            <div class="space-y-4">
                <button id="continue-quiz-btn" class="w-64 bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-6 rounded-lg">
                    ì´ì–´ í’€ê¸°
                </button>
                <button id="quit-quiz-btn" class="w-64 bg-red-600 hover:bg-red-700 text-white text-xl font-bold py-4 px-6 rounded-lg">
                    ê·¸ë§Œ í’€ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- 7. ì˜¤ë‹µ ì¬í’€ì´ ì•Œë¦¼ --><div id="retake-modal" class="screen flex-col justify-center items-center z-40 text-white"> <!-- text-white ê³ ì • -->
        <div class="fixed inset-0 bg-black bg-opacity-80"></div>
        <h2 class="text-4xl font-bold relative z-10">í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</h2>
    </div>

    <!-- 8. ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ --><div id="alert-modal" class="screen flex-col justify-center items-center z-50 text-white"> <!-- text-white ê³ ì • -->
        <div class="fixed inset-0 bg-black bg-opacity-80"></div>
        <div class="relative z-10 bg-gray-800 p-8 rounded-2xl shadow-xl text-center max-w-sm w-full mx-4">
            <h2 id="alert-message" class="text-2xl font-bold mb-6 text-white">ì•Œë¦¼ ë©”ì‹œì§€</h2>
            <button id="alert-ok-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">
                í™•ì¸
            </button>
        </div>
    </div>

    <!-- Firebase SDK --><script type="module">
        // Firebase (ì œê³µëœ ë‚´ìš© ëŒ€ì‹  ìº”ë²„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs, 
            serverTimestamp,
            setLogLevel,
            increment // â­ï¸ 1. ì™„ë£Œ íšŸìˆ˜ ì¹´ìš´íŠ¸ë¥¼ ìœ„í•´ 'increment' ì„í¬íŠ¸
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig, appId;

        // ìº”ë²„ìŠ¤ í™˜ê²½ì¸ì§€ í™•ì¸
        if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
            // ìº”ë²„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
            firebaseConfig = JSON.parse(__firebase_config);
            appId = __app_id;
            console.log("Running in Canvas environment.");
        } else {
            // GitHub Pages ë“± ë…ë¦½ í™˜ê²½ì„ ìœ„í•œ í•˜ë“œì½”ë”©ëœ ê°’
            console.log("Running in standalone environment (e.g., GitHub Pages).");
            firebaseConfig = {
                apiKey: "AIzaSyCLXhRToRyjQ1qXkpO37IOXm1JasEzhXNw",
                authDomain: "quizproject-a64ce.firebaseapp.com",
                projectId: "quizproject-a64ce",
                storageBucket: "quizproject-a64ce.firebasestorage.app",
                messagingSenderId: "14288490981",
                appId: "1:14288490981:web:11c5bf919120fbf3f09f0c"
            };
            appId = 'mz-flashcard-github-io';
        }
        
        let app, db, auth, userId;
        let problemSetsCache = []; // ì „ì²´ ë¬¸ì œ ì„¸íŠ¸ ìºì‹œ
        let publicProblemSets = []; // ê³µê°œ ë¬¸ì œ ì„¸íŠ¸ ìºì‹œ
        let selectedSetId = null;
        let isReverseMode = false;
        let mainListUnsubscribe = null; // ë©”ì¸ ë¦¬ìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        let adminListUnsubscribe = null; // ê´€ë¦¬ì ë¦¬ìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        let lastActiveScreen = 'mainScreen'; // ì•Œë¦¼ ëª¨ë‹¬ì„ ìœ„í•œ ë§ˆì§€ë§‰ í™”ë©´ ì €ì¥
        let afterAlertCallback = null; // ì•Œë¦¼ ëª¨ë‹¬ í™•ì¸ í›„ ì½œë°±

        // í€´ì¦ˆ ìƒíƒœ
        let currentQuiz = {
            questions: [],
            currentIndex: 0,
            incorrectAnswers: [],
            isRetakeRound: false
        };

        // DOM ìš”ì†Œ
        const screens = {};
        const dom = {
            loadingOverlay: document.getElementById('loading-overlay'),
            animatedBg: document.getElementById('animated-bg'),
            // ë©”ì¸
            mainScreen: document.getElementById('main-screen'),
            mainTitle: document.getElementById('main-title'), // H1 (Flash Card)
            adminPanelBtn: document.getElementById('main-admin-btn'),
            reverseToggle: document.getElementById('reverse-mode-toggle'),
            searchBar: document.getElementById('search-bar'),
            problemListHeader: document.getElementById('problem-list-header'), // H2 (ë¬¸ì œ ë¦¬ìŠ¤íŠ¸)
            problemListContainer: document.getElementById('problem-list-container'),
            noPublicSets: document.getElementById('no-public-sets'),
            startQuizBtn: document.getElementById('start-quiz-btn'),
            // ê´€ë¦¬ì ë¡œê·¸ì¸
            adminLoginScreen: document.getElementById('admin-login-screen'),
            passwordInput: document.getElementById('admin-password-input'),
            loginBtn: document.getElementById('admin-login-btn'),
            loginError: document.getElementById('login-error'),
            adminLoginBackBtn: document.getElementById('admin-login-back-btn'),
            // ê´€ë¦¬ì íŒ¨ë„
            adminPanelScreen: document.getElementById('admin-panel-screen'),
            adminPanelBackBtn: document.getElementById('admin-panel-back-btn'),
            adminAddSetBtn: document.getElementById('admin-add-set-btn'),
            adminProblemList: document.getElementById('admin-problem-list'),
            // ê´€ë¦¬ì ìˆ˜ì •
            adminEditScreen: document.getElementById('admin-edit-screen'),
            adminEditBackBtn: document.getElementById('admin-edit-back-btn'),
            editScreenTitle: document.getElementById('edit-screen-title'),
            saveSetBtn: document.getElementById('save-set-btn'),
            editSetId: document.getElementById('edit-set-id'),
            setTitleInput: document.getElementById('set-title-input'),
            setDescriptionInput: document.getElementById('set-description-input'),
            addQaPairBtn: document.getElementById('add-qa-pair-btn'),
            qaListContainer: document.getElementById('qa-list-container'),
            // í€´ì¦ˆ
            quizScreen: document.getElementById('quiz-screen'),
            pauseBtn: document.getElementById('pause-btn'),
            quizProgress: document.getElementById('quiz-progress'),
            questionText: document.getElementById('question-text'),
            answerInput: document.getElementById('answer-input'),
            feedbackMessage: document.getElementById('feedback-message'),
            nextQuestionBtn: document.getElementById('next-question-btn'),
            // ëª¨ë‹¬
            pauseModal: document.getElementById('pause-modal'),
            continueQuizBtn: document.getElementById('continue-quiz-btn'),
            quitQuizBtn: document.getElementById('quit-quiz-btn'),
            retakeModal: document.getElementById('retake-modal'),
            alertModal: document.getElementById('alert-modal'),
            alertMessage: document.getElementById('alert-message'),
            alertOkBtn: document.getElementById('alert-ok-btn'),
        };

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        function showLoading(show) {
            dom.loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // ì•Œë¦¼ ëª¨ë‹¬
        function showAlert(message, callback = null) {
            dom.alertMessage.textContent = message;
            afterAlertCallback = callback;
            showScreen('alertModal');
        }

        // í™”ë©´ ì „í™˜
        function showScreen(screenId) {
            if (screenId !== 'alertModal' && screenId !== 'pauseModal' && screenId !== 'retakeModal') {
                lastActiveScreen = screenId;
            }
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenId]) {
                screens[screenId].classList.add('active');
            }
            
            // í€´ì¦ˆ í™”ë©´ì´ ì•„ë‹ ë•ŒëŠ” ë°°ê²½ ë³´ì´ê¸°
            if (screenId !== 'quizScreen') {
                dom.animatedBg.style.display = 'block';
            }
        }

        // ë‚ ì§œ í¬ë§· (ì˜ˆ: 2025. 11. 1.)
        function formatDate(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
            return timestamp.toDate().toLocaleDateString('ko-KR');
        }

        // ë°°ê²½ ë‹¨ì–´ ìƒì„±
        function generateBackgroundWords() {
            const words = [
                'êµ­ì–´', 'ìˆ˜í•™', 'ê³¼í•™', 'ì˜ì–´', 'ì—­ì‚¬', 'ì‚¬íšŒ', 'Atom', 'ì•™ê¸ˆ', 'í”„ë¡œì íŠ¸', 
                'ë…¼ìˆ ', 'ì‚¼ê°í˜•', 'í™”í•™', 'ì˜ˆìˆ ', 'ì§€êµ¬ê³¼í•™', 'Literature', 'Calculus', 
                'Science', 'English', 'History', 'Coding', 'Physics', 'Chemistry',
                '100%!!!', 'Data', 'React', 'Python', 'ë³µì‚¬', 'C++', 'Never Give Up!'
            ];
            const container = dom.animatedBg;
            const wordCount = 40; // ë‹¨ì–´ ë°€ë„

            for (let i = 0; i < wordCount; i++) {
                const span = document.createElement('span');
                span.className = 'bg-word';
                span.textContent = words[Math.floor(Math.random() * words.length)];
                span.style.left = `${Math.random() * 100}vw`;
                span.style.top = `${Math.random() * 100}vh`;
                span.style.fontSize = `${2 + Math.random() * 3}em`;
                span.style.animationDelay = `${Math.random() * -40}s`; // ìŒìˆ˜ ë”œë ˆì´ë¡œ ì¦‰ì‹œ ì‹œì‘
                span.style.animationDuration = `${20 + Math.random() * 20}s`; // ë‹¤ì–‘í•œ ì†ë„
                container.appendChild(span);
            }
        }

        // --- ì´ˆê¸°í™” ---

        async function initialize() {
            // DOM ìŠ¤í¬ë¦° ê°ì²´í™”
            screens.mainScreen = dom.mainScreen;
            screens.adminLoginScreen = dom.adminLoginScreen;
            screens.adminPanelScreen = dom.adminPanelScreen;
            screens.adminEditScreen = dom.adminEditScreen;
            screens.quizScreen = dom.quizScreen;
            screens.pauseModal = dom.pauseModal;
            screens.retakeModal = dom.retakeModal;
            screens.alertModal = dom.alertModal;

            // ë°°ê²½ ìƒì„±
            generateBackgroundWords();
            
            // ì´ˆê¸° ìƒ‰ìƒ ì„¤ì •
            handleReverseToggle({ target: { checked: false } }); // isReverseMode = false
            
            showLoading(true);
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Firebase ë¡œê·¸ í™œì„±í™”

                // ìµëª… ë¡œê·¸ì¸ ë˜ëŠ” ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                        if (user) {
                            userId = user.uid;
                            console.log("User already signed in:", userId);
                            resolve();
                        // ìº”ë²„ìŠ¤ í™˜ê²½ì¼ ë•Œë§Œ ì»¤ìŠ¤í…€ í† í° ì‹œë„
                        } else if (typeof __initial_auth_token !== 'undefined' && typeof __app_id !== 'undefined') {
                            try {
                                const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                                userId = userCredential.user.uid;
                                console.log("Signed in with custom token:", userId);
                                resolve();
                            } catch (error) {
                                console.error("Custom token sign-in error:", error);
                                reject(error);
                            }
                        } else {
                            // ë…ë¦½ í™˜ê²½ì´ê±°ë‚˜ ìº”ë²„ìŠ¤ì—ì„œ í† í°ì´ ì—†ëŠ” ê²½ìš° ìµëª… ë¡œê·¸ì¸
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously:", userId);
                                resolve();
                            } catch (error) {
                                console.error("Anonymous sign-in error:", error);
                                reject(error);
                            }
                        }
                    });
                });

                // ë©”ì¸ í™”ë©´ ë°ì´í„° ë¡œë“œ
                loadMainProblemSets();
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
                bindEventListeners();
                
                showScreen('mainScreen');
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showAlert("ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
            } finally {
                showLoading(false);
            }
        }

        // --- ë°ì´í„° ë¡œë“œ (Firebase) ---

        // ë©”ì¸ í™”ë©´ìš© (ê³µê°œëœ ì„¸íŠ¸ë§Œ)
        function loadMainProblemSets() {
            if (mainListUnsubscribe) mainListUnsubscribe(); // ì´ì „ ë¦¬ìŠ¤ë„ˆ í•´ì œ

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets'), where("isPublic", "==", true));
            mainListUnsubscribe = onSnapshot(q, (querySnapshot) => {
                publicProblemSets = [];
                querySnapshot.forEach((doc) => {
                    publicProblemSets.push({ id: doc.id, ...doc.data() });
                });
                renderMainProblemList(publicProblemSets);
            }, (error) => {
                console.error("ê³µê°œ ë¬¸ì œ ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
            });
        }

        // ê´€ë¦¬ììš© (ëª¨ë“  ì„¸íŠ¸)
        function loadAdminProblemSets() {
            if (adminListUnsubscribe) adminListUnsubscribe(); // ì´ì „ ë¦¬ìŠ¤ë„ˆ í•´ì œ

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets'));
            adminListUnsubscribe = onSnapshot(q, (querySnapshot) => {
                problemSetsCache = [];
                querySnapshot.forEach((doc) => {
                    problemSetsCache.push({ id: doc.id, ...doc.data() });
                });
                renderAdminProblemList(problemSetsCache);
            }, (error) => {
                console.error("ì „ì²´ ë¬¸ì œ ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
            });
        }

        // --- ë Œë”ë§ í•¨ìˆ˜ ---

        // ë©”ì¸ í™”ë©´ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderMainProblemList(sets) {
            dom.problemListContainer.innerHTML = '';
            const query = dom.searchBar.value.toLowerCase();
            const filteredSets = sets.filter(set => 
                set.title.toLowerCase().includes(query) || 
                (set.description && set.description.toLowerCase().includes(query))
            );

            if (filteredSets.length === 0) {
                dom.noPublicSets.style.display = 'block';
                return;
            }

            dom.noPublicSets.style.display = 'none';

            filteredSets.forEach(set => {
                const isSelected = set.id === selectedSetId;
                const setEl = document.createElement('div');
                setEl.className = `set-item p-4 border-2 border-gray-700 rounded-lg cursor-pointer transition-all bg-gray-800 bg-opacity-70 hover:bg-gray-700 ${isSelected ? 'selected' : ''} text-white`;
                setEl.dataset.id = set.id;

                setEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold">${set.title}</h3>
                            <p class="text-gray-300 mt-1">${set.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                            <p class="text-sm text-gray-400 mt-2">
                                ìµœì¢… ìˆ˜ì •: ${formatDate(set.lastModified)}
                                <!-- â­ï¸ 2. ì™„ë£Œ íšŸìˆ˜ í‘œì‹œ -->
                                <span class="ml-3 font-medium text-yellow-400">(${set.completionCount || 0}íšŒ ì™„ë£Œë¨)</span>
                            </p>
                        </div>
                        ${isSelected ? '<span class="selected-text text-sm font-bold bg-yellow-300 text-yellow-900 px-2 py-1 rounded">ì„ íƒë¨</span>' : ''}
                    </div>
                `;
                
                // ì„ íƒ ì´ë²¤íŠ¸
                setEl.addEventListener('click', () => handleSelectSet(set.id, set.title));
                dom.problemListContainer.appendChild(setEl);
            });
        }

        // ê´€ë¦¬ì í™”ë©´ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderAdminProblemList(sets) {
            dom.adminProblemList.innerHTML = '';
            if (sets.length === 0) {
                dom.adminProblemList.innerHTML = '<p class="text-center">ë¬¸ì œ ì„¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>';
                return;
            }

            // ì •ë ¬ (ìµœì‹ ìˆœ)
            const sortedSets = sets.sort((a, b) => (b.lastModified?.toDate() || 0) - (a.lastModified?.toDate() || 0));

            sortedSets.forEach(set => {
                const setEl = document.createElement('div');
                setEl.className = 'p-4 border border-gray-700 rounded-lg bg-gray-800 flex justify-between items-center text-white'; // text-white ê³ ì •
                
                setEl.innerHTML = `
                    <div class="flex-1">
                        <h3 class="text-xl font-bold ${set.isPublic ? 'text-green-400' : 'text-gray-400'}">${set.title} ${set.isPublic ? '(ê³µê°œë¨)' : '(ë¹„ê³µê°œ)'}</h3>
                        <p class="text-gray-300">${set.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                        <p class="text-sm text-gray-500">
                            ìˆ˜ì •: ${formatDate(set.lastModified)}
                            <!-- â­ï¸ 2. (ê´€ë¦¬ì) ì™„ë£Œ íšŸìˆ˜ í‘œì‹œ -->
                            <span class="ml-3 font-medium text-yellow-500">(${set.completionCount || 0}íšŒ ì™„ë£Œ)</span>
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- ê³µê°œ/ë¹„ê³µê°œ í† ê¸€ --><label class="switch" title="${set.isPublic ? 'ë¹„ê³µê°œë¡œ' : 'ê³µê°œë¡œ'}">
                            <input type="checkbox" class="toggle-public" data-id="${set.id}" ${set.isPublic ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                        <button class="edit-set-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-lg" data-id="${set.id}" title="ìˆ˜ì •">âœï¸</button>
                        <button class="delete-set-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg" data-id="${set.id}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                `;
                dom.adminProblemList.appendChild(setEl);
            });

            // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
            bindAdminListButtons();
        }

        // Q&A ëª©ë¡ ë Œë”ë§ (ê´€ë¦¬ì ìˆ˜ì •)
        function renderQAPair(question = '', answer = '') {
            const pairEl = document.createElement('div');
            pairEl.className = 'qa-pair p-4 bg-gray-800 rounded-lg space-y-2 relative';
            
            pairEl.innerHTML = `
                <button class="delete-qa-btn absolute -top-2 -right-2 bg-red-700 w-6 h-6 rounded-full text-white text-xs font-bold">X</button>
                <input type="text" class="qa-question w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" value="${escapeHtml(question)}" placeholder="ë¬¸ì œ">
                <input type="text" class="qa-answer w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" value="${escapeHtml(answer)}" placeholder="ì •ë‹µ">
            `;

            pairEl.querySelector('.delete-qa-btn').addEventListener('click', () => {
                pairEl.remove();
            });

            dom.qaListContainer.appendChild(pairEl);
        }

        function escapeHtml(str) {
            return str.replace(/"/g, '&quot;');
        }

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

        function bindEventListeners() {
            // ë©”ì¸
            dom.adminPanelBtn.addEventListener('click', () => {
                dom.passwordInput.value = '';
                dom.loginError.classList.add('hidden');
                showScreen('adminLoginScreen');
            });
            dom.reverseToggle.addEventListener('change', handleReverseToggle);
            dom.searchBar.addEventListener('input', () => renderMainProblemList(publicProblemSets));
            dom.startQuizBtn.addEventListener('click', handleStartQuiz);

            // ê´€ë¦¬ì ë¡œê·¸ì¸
            dom.loginBtn.addEventListener('click', handleAdminLogin);
            dom.adminLoginBackBtn.addEventListener('click', () => showScreen('mainScreen'));
            dom.passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleAdminLogin();
            });

            // ê´€ë¦¬ì íŒ¨ë„
            dom.adminPanelBackBtn.addEventListener('click', () => {
                if(adminListUnsubscribe) adminListUnsubscribe(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                showScreen('mainScreen'); // ë©”ì¸ìœ¼ë¡œ
            });
            dom.adminAddSetBtn.addEventListener('click', () => handleShowEditScreen());

            // ê´€ë¦¬ì ìˆ˜ì •
            dom.adminEditBackBtn.addEventListener('click', () => showScreen('adminPanelScreen'));
            dom.addQaPairBtn.addEventListener('click', () => renderQAPair());
            dom.saveSetBtn.addEventListener('click', handleSaveSet);

            // í€´ì¦ˆ
            dom.pauseBtn.addEventListener('click', () => showScreen('pauseModal'));
            dom.continueQuizBtn.addEventListener('click', () => showScreen('quizScreen'));
            dom.quitQuizBtn.addEventListener('click', () => {
                showScreen('mainScreen');
            });
            dom.nextQuestionBtn.addEventListener('click', nextQuestion);
            dom.answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // í”¼ë“œë°±ì´ ë³´ì´ëŠ” ìƒíƒœ(í‹€ë¦° ìƒíƒœ)ë©´ ë‹¤ìŒìœ¼ë¡œ, ì•„ë‹ˆë©´ ì •ë‹µ í™•ì¸
                    if (dom.feedbackMessage.textContent && !dom.nextQuestionBtn.classList.contains('hidden')) {
                        nextQuestion();
                    } else if (!dom.feedbackMessage.textContent) {
                        checkAnswer();
                    }
                }
            });

            // ì•Œë¦¼ ëª¨ë‹¬
            dom.alertOkBtn.addEventListener('click', () => {
                if (afterAlertCallback) {
                    afterAlertCallback();
                    afterAlertCallback = null;
                } else {
                    showScreen(lastActiveScreen); // ê¸°ë³¸: ì´ì „ í™”ë©´ìœ¼ë¡œ
                }
            });
        }
        
        function bindAdminListButtons() {
            // ìˆ˜ì •
            document.querySelectorAll('.edit-set-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleShowEditScreen(e.currentTarget.dataset.id);
                });
            });
            // ì‚­ì œ
            document.querySelectorAll('.delete-set-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleDeleteSet(e.currentTarget.dataset.id);
                });
            });
            // ê³µê°œ í† ê¸€
            document.querySelectorAll('.toggle-public').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    handleTogglePublic(e.currentTarget.dataset.id, e.currentTarget.checked);
                });
            });
        }

        // ë©”ì¸: ê±°ê¾¸ë¡œ ëª¨ë“œ
        function handleReverseToggle(e) {
            isReverseMode = e.target.checked;
            dom.animatedBg.classList.toggle('reverse-active', isReverseMode);
            document.body.classList.toggle('reverse-active', isReverseMode);
            
            // H1, H2, P íƒœê·¸ ìƒ‰ìƒ ë™ì  ë³€ê²½
            const newColor = isReverseMode ? 'white' : '#333';
            if (dom.mainTitle) {
                dom.mainTitle.style.color = newColor;
            }
            if (dom.problemListHeader) {
                dom.problemListHeader.style.color = newColor;
            }
            if (dom.noPublicSets) {
                dom.noPublicSets.style.color = newColor;
            }
        }

        // ë©”ì¸: ë¬¸ì œ ì„¸íŠ¸ ì„ íƒ
        function handleSelectSet(setId, setTitle) {
            selectedSetId = setId;
            // UI ì—…ë°ì´íŠ¸
            renderMainProblemList(publicProblemSets);
            // ë²„íŠ¼ í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
            dom.startQuizBtn.disabled = false;
            dom.startQuizBtn.textContent = `'${setTitle}' ì„¸íŠ¸ í’€ì´ ì‹œì‘í•˜ê¸°`;
        }

        // ë©”ì¸: í€´ì¦ˆ ì‹œì‘
        function handleStartQuiz() {
            if (!selectedSetId) return;

            const set = publicProblemSets.find(s => s.id === selectedSetId);
            if (!set || !set.questions || set.questions.length === 0) {
                showAlert("ë¬¸ì œê°€ ì—†ëŠ” ì„¸íŠ¸ì…ë‹ˆë‹¤.");
                return;
            }

            startQuiz(set.questions);
        }

        // ê´€ë¦¬ì: ë¡œê·¸ì¸
        function handleAdminLogin() {
            if (dom.passwordInput.value === '251414') {
                dom.loginError.classList.add('hidden');
                loadAdminProblemSets(); // ê´€ë¦¬ì íŒ¨ë„ ë°ì´í„° ë¡œë“œ
                showScreen('adminPanelScreen');
            } else {
                dom.loginError.classList.remove('hidden');
            }
        }

        // ê´€ë¦¬ì: ìˆ˜ì •/ì¶”ê°€ í™”ë©´ ë³´ì´ê¸°
        function handleShowEditScreen(setId = null) {
            // í¼ ë¦¬ì…‹
            dom.editSetId.value = setId || '';
            dom.setTitleInput.value = '';
            dom.setDescriptionInput.value = '';
            dom.qaListContainer.innerHTML = '';

            if (setId) {
                // ìˆ˜ì • ëª¨ë“œ
                dom.editScreenTitle.textContent = 'ë¬¸ì œ ì„¸íŠ¸ ìˆ˜ì •';
                const set = problemSetsCache.find(s => s.id === setId);
                if (set) {
                    dom.setTitleInput.value = set.title;
                    dom.setDescriptionInput.value = set.description || '';
                    if (set.questions) {
                        set.questions.forEach(qa => renderQAPair(qa.q, qa.a));
                    }
                }
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                dom.editScreenTitle.textContent = 'ë¬¸ì œ ì„¸íŠ¸ ë§Œë“¤ê¸°';
                renderQAPair(); // ê¸°ë³¸ 1ê°œ ì¶”ê°€
            }
            showScreen('adminEditScreen');
        }

        // ê´€ë¦¬ì: ì €ì¥
        async function handleSaveSet() {
            const title = dom.setTitleInput.value.trim();
            if (!title) {
                showAlert("ë¬¸ì œ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }

            const description = dom.setDescriptionInput.value.trim();
            const setId = dom.editSetId.value;

            // Q&A ëª©ë¡ ìˆ˜ì§‘
            const questions = [];
            const qaPairs = document.querySelectorAll('.qa-pair');
            qaPairs.forEach(pair => {
                const q = pair.querySelector('.qa-question').value.trim();
                const a = pair.querySelector('.qa-answer').value.trim();
                if (q && a) {
                    questions.push({ q, a });
                }
            });

            if (questions.length === 0) {
                showAlert("í•˜ë‚˜ ì´ìƒì˜ ë¬¸ì œì™€ ì •ë‹µì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            const setData = {
                title,
                description,
                questions,
                lastModified: serverTimestamp() // ì„œë²„ ì‹œê°„
            };

            showLoading(true);
            try {
                if (setId) {
                    // ìˆ˜ì •
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets', setId);
                    await updateDoc(docRef, setData);
                } else {
                    // ìƒˆë¡œ ì¶”ê°€ (ê¸°ë³¸ ë¹„ê³µê°œ)
                    setData.isPublic = false;
                    setData.completionCount = 0; // â­ï¸ 3. ìƒˆë¡œ ë§Œë“¤ ë•Œ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets'), setData);
                }
                showLoading(false);
                showScreen('adminPanelScreen');
            } catch (error) {
                showLoading(false);
                console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                showAlert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ê´€ë¦¬ì: ì‚­ì œ
        async function handleDeleteSet(setId) {
            // (ìš”ì²­ì‚¬í•­: í™•ì¸ ì°½ ê¸ˆì§€ -> ëŒ€ì‹  ì»¤ìŠ¤í…€ ì•Œë¦¼ ì‚¬ìš©)
            // ì‹¤ì œ ì‚­ì œ ë¡œì§ì€ í™•ì¸ í›„ì—ë§Œ ì‹¤í–‰í•´ì•¼ í•˜ì§€ë§Œ, ìš”ì²­ëŒ€ë¡œ ì¼ë‹¨ ë°”ë¡œ ì‚­ì œ
            showLoading(true);
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets', setId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
                showAlert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                showLoading(false);
            }
        }

        // ê´€ë¦¬ì: ê³µê°œ/ë¹„ê³µê°œ
        async function handleTogglePublic(setId, isPublic) {
            showLoading(true);
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets', setId);
                await updateDoc(docRef, { isPublic });
            } catch (error) {
                console.error("ê³µê°œ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:", error);
                showAlert("ê³µê°œ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                showLoading(false);
            }
        }

        // --- í€´ì¦ˆ ë¡œì§ ---

        // â­ï¸ 4. ì™„ë£Œ íšŸìˆ˜ ì¦ê°€ í•¨ìˆ˜
        async function incrementCompletionCount(setId) {
            if (!setId) return;
            console.log(`Incrementing completion count for set: ${setId}`);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'flashcard-sets', setId);
            try {
                // 'completionCount' í•„ë“œë¥¼ 1 ì¦ê°€ì‹œí‚´
                await updateDoc(docRef, {
                    completionCount: increment(1)
                });
            } catch (error) {
                console.error("Failed to increment completion count:", error);
                // ì´ê²ƒì€ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì´ë¯€ë¡œ ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }
        }
        
        // í”¼ì…”-ì˜ˆì´ì¸  ì…”í”Œ
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz(questions) {
            let preparedQuestions = questions.map(qa => ({...qa})); // ê¹Šì€ ë³µì‚¬

            // ê±°ê¾¸ë¡œ ëª¨ë“œ ì ìš©
            if (isReverseMode) {
                preparedQuestions = preparedQuestions.map(qa => ({ q: qa.a, a: qa.q }));
            }
            
            currentQuiz = {
                questions: shuffle(preparedQuestions),
                currentIndex: 0,
                incorrectAnswers: [],
                isRetakeRound: false
            };

            showScreen('quizScreen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuiz.currentIndex >= currentQuiz.questions.length) {
                // í•œ ë¼ìš´ë“œ ì¢…ë£Œ
                endOfRound();
                return;
            }

            const q = currentQuiz.questions[currentQuiz.currentIndex];
            dom.questionText.textContent = q.q;
            dom.answerInput.value = '';
            dom.answerInput.disabled = false;
            dom.feedbackMessage.textContent = '';
            dom.feedbackMessage.className = 'mt-6 text-2xl font-semibold h-10';
            dom.nextQuestionBtn.classList.add('hidden');
            
            dom.quizProgress.textContent = `${currentQuiz.currentIndex + 1} / ${currentQuiz.questions.length}`;

            // ì˜¤í†  í¬ì»¤ìŠ¤
            setTimeout(() => dom.answerInput.focus(), 100);
        }

        function checkAnswer() {
            const userAnswer = dom.answerInput.value; // ë„ì–´ì“°ê¸° ìœ ì§€ (trim() ì œê±°)
            const correctAnswer = currentQuiz.questions[currentQuiz.currentIndex].a;

            dom.answerInput.disabled = true;
            
            // 6. ëŒ€ì†Œë¬¸ì, ë„ì–´ì“°ê¸° êµ¬ë¶„ (ì™„ì „ ì¼ì¹˜)
            if (userAnswer === correctAnswer) {
                // ì •ë‹µ
                dom.feedbackMessage.textContent = 'ì •ë‹µì…ë‹ˆë‹¤.';
                dom.feedbackMessage.classList.add('text-green-400');
                
                // 6. ì ë‹¹í•œ ì‹œê°„ ë’¤ ìë™ ë‹¤ìŒ ë¬¸ì œ
                setTimeout(nextQuestion, 1500);

            } else {
                // ì˜¤ë‹µ
                dom.feedbackMessage.textContent = `í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µì€: ${correctAnswer}`;
                dom.feedbackMessage.classList.add('text-red-400');
                dom.nextQuestionBtn.classList.remove('hidden');

                // 6. ì˜¤ë‹µ ë¬¸ì œ ê¸°ë¡
                currentQuiz.incorrectAnswers.push(currentQuiz.questions[currentQuiz.currentIndex]);
            }
        }

        function nextQuestion() {
            currentQuiz.currentIndex++;
            loadQuestion();
        }

        function endOfRound() {
            if (currentQuiz.incorrectAnswers.length > 0) {
                // 6-1. ì˜¤ë‹µ ë¬¸ì œ ì¬í’€ì´
                showScreen('retakeModal');

                setTimeout(() => {
                    currentQuiz = {
                        questions: shuffle(currentQuiz.incorrectAnswers), // ì˜¤ë‹µ ëª©ë¡ìœ¼ë¡œ ì¬ì„¤ì •
                        currentIndex: 0,
                        incorrectAnswers: [], // ì˜¤ë‹µ ëª©ë¡ ì´ˆê¸°í™”
                        isRetakeRound: true
                    };
                    showScreen('quizScreen');
                    loadQuestion();
                }, 2000); // 2ì´ˆê°„ ë©”ì‹œì§€ í‘œì‹œ

            } else {
                // ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜ (ë˜ëŠ” ì˜¤ë‹µ ì¬í’€ì´ ì¢…ë£Œ)
                
                // â­ï¸ 5. í€´ì¦ˆë¥¼ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìœ¼ë¯€ë¡œ ì¹´ìš´íŠ¸ ì¦ê°€
                incrementCompletionCount(selectedSetId); 

                const message = currentQuiz.isRetakeRound ? "ì˜¤ë‹µ ì •ë³µ ì™„ë£Œ! ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤." : "ì™„ë²½í•©ë‹ˆë‹¤! ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤.";
                showAlert(message, () => {
                    showScreen('mainScreen');
                });
            }
        }

        // --- ì•± ì‹œì‘ ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>

